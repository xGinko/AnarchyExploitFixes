package me.xginko.aef.utils.tickdata;

import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import org.bukkit.Server;
import org.bukkit.plugin.java.JavaPlugin;

import java.time.Duration;

@SuppressWarnings("DataFlowIssue")
public final class ModernPaperTickReporter implements TickReporter {

    private final Server server;
    private final Cache<Boolean, Double> cache;

    public ModernPaperTickReporter(JavaPlugin plugin, Duration cacheTime) {
        this.server = plugin.getServer();
        this.cache = Caffeine.newBuilder().expireAfterWrite(cacheTime).build();
    }

    public static boolean isSupported() {
        try {
            Server.class.getMethod("getAverageTickTime");
            return true;
        } catch (NoSuchMethodException e) {
            return false;
        }
    }

    @Override
    public void disable() {
        cache.invalidateAll();
        cache.cleanUp();
    }

    /**
     * Gets the current server TPS
     *
     * @return the TPS of the last 1m in Paper-Server
     */
    @Override
    public double getGlobalTPS() {
        return cache.get(true, k -> server.getTPS()[0]);
    }

    @Override
    public double getTPS() {
        return getGlobalTPS();
    }

    /**
     * Get the average tick time of the last 5s (in millis)
     *
     * @return Average tick time (in millis)
     */
    @Override
    public double getGlobalMSPT() {
        return cache.get(false, k -> server.getAverageTickTime());
    }

    @Override
    public double getMSPT() {
        return getGlobalMSPT();
    }
}
