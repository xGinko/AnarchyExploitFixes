package me.moomoo.anarchyexploitfixes.commands;

import cloud.commandframework.annotations.AnnotationParser;
import cloud.commandframework.arguments.parser.StandardParameters;
import cloud.commandframework.bukkit.CloudBukkitCapabilities;
import cloud.commandframework.execution.AsynchronousCommandExecutionCoordinator;
import cloud.commandframework.meta.CommandMeta;
import cloud.commandframework.paper.PaperCommandManager;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import net.kyori.adventure.text.TextReplacementConfig;
import org.bukkit.command.CommandSender;

import java.util.Set;
import java.util.function.Function;

public interface AEFCommand {

    boolean shouldRegister();

    static void registerCommands() {
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        try {
            PaperCommandManager<CommandSender> manager = new PaperCommandManager<>(
                    /* Owning plugin */ plugin,
                    /* Coordinator function */ AsynchronousCommandExecutionCoordinator.<CommandSender>builder().build(),
                    /* Command Sender -> C */ Function.identity(),
                    /* C -> Command Sender */ Function.identity()
            );

            if (manager.hasCapability(CloudBukkitCapabilities.BRIGADIER))
                manager.registerBrigadier();
            if (manager.hasCapability(CloudBukkitCapabilities.ASYNCHRONOUS_COMPLETION))
                manager.registerAsynchronousCompletions();

            // Command error messages
            manager.registerExceptionHandler(cloud.commandframework.exceptions.NoPermissionException.class, (sender, exception) ->
                    sender.sendMessage(AnarchyExploitFixes.getLang(sender).no_permission));
            manager.registerExceptionHandler(cloud.commandframework.exceptions.ArgumentParseException.class, (sender, exception) ->
                    sender.sendMessage(AnarchyExploitFixes.getLang(sender).failed_argument_parse));
            manager.registerExceptionHandler(cloud.commandframework.exceptions.InvalidSyntaxException.class, (sender, exception) ->
                    sender.sendMessage(AnarchyExploitFixes.getLang(sender).invalid_syntax
                            .replaceText(TextReplacementConfig.builder().matchLiteral("%syntax%").replacement("/"+exception.getCorrectSyntax()).build())));

            final AnnotationParser<CommandSender> parser = new AnnotationParser<>(
                    manager,
                    CommandSender.class,
                    parameters -> CommandMeta.simple().with(
                            CommandMeta.DESCRIPTION,
                            parameters.get(StandardParameters.DESCRIPTION, "No description")
                    ).build()
            );

            for (AEFCommand command : Set.of(
                    new AEFCmd(),
                    new HelpCmd(),
                    new SayCmd(),
                    new ToggleConnectionMsgsCmd()
            )) {
                if (command.shouldRegister()) {
                    parser.parse(command);
                }
            }
        } catch (Throwable t) {
            plugin.getLogger().severe("Error registering commands! - " + t.getLocalizedMessage());
            plugin.getServer().getPluginManager().disablePlugin(plugin);
        }
    }
}