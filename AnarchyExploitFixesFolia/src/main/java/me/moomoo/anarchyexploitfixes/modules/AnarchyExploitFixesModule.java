package me.moomoo.anarchyexploitfixes.modules;

import com.comphenix.protocol.ProtocolLibrary;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.modules.bedrock.*;
import me.moomoo.anarchyexploitfixes.modules.chat.PreventPluginScanning;
import me.moomoo.anarchyexploitfixes.modules.chat.commandwhitelist.CommandWhitelist;
import me.moomoo.anarchyexploitfixes.modules.chunklimits.*;
import me.moomoo.anarchyexploitfixes.modules.combat.*;
import me.moomoo.anarchyexploitfixes.modules.dupepreventions.*;
import me.moomoo.anarchyexploitfixes.modules.elytra.*;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.BannedMaterial;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.BannedItemNames;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.OverstackedItems;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.RevertUnbreakables;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.enchantments.HigherEnchants;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.enchantments.InapplicableEnchants;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.enchantments.IncompatibleEnchants;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.enchantments.SpecificHigherEnchants;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.nbt.DamageModifierTags;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.nbt.FilledStorageItemTags;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.playerheads.BanPlayerHeads;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.playerheads.PreventPlacingPlayerHeads;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.spawneggs.PreventUsingSpawnEggs;
import me.moomoo.anarchyexploitfixes.modules.illegals.items.spawneggs.RemoveSpawnEggs;
import me.moomoo.anarchyexploitfixes.modules.illegals.placedblocks.PeriodicallyRemoveIllegalBlocks;
import me.moomoo.anarchyexploitfixes.modules.illegals.placedblocks.RemoveIllegalBlocksOnChunkload;
import me.moomoo.anarchyexploitfixes.modules.illegals.placedblocks.RemoveUnnaturalSpawners;
import me.moomoo.anarchyexploitfixes.modules.lagpreventions.*;
import me.moomoo.anarchyexploitfixes.modules.lagpreventions.lowtpsphysics.*;
import me.moomoo.anarchyexploitfixes.modules.misc.FirstJoinMessages;
import me.moomoo.anarchyexploitfixes.modules.misc.JoinLeaveMessages;
import me.moomoo.anarchyexploitfixes.modules.misc.MaskKickMessages;
import me.moomoo.anarchyexploitfixes.modules.misc.PreventMessageKick;
import me.moomoo.anarchyexploitfixes.modules.patches.*;
import me.moomoo.anarchyexploitfixes.modules.preventions.BedTrap;
import me.moomoo.anarchyexploitfixes.modules.preventions.NetherRoof;
import me.moomoo.anarchyexploitfixes.modules.preventions.PreventNonSurvival;
import me.moomoo.anarchyexploitfixes.modules.preventions.PreventOppedPlayers;
import me.moomoo.anarchyexploitfixes.modules.preventions.blockbreak.PistonExplodePermBlockRemoval;
import me.moomoo.anarchyexploitfixes.modules.preventions.blockbreak.PistonPlaceWhileRetractPermBlockRemoval;
import me.moomoo.anarchyexploitfixes.modules.preventions.blockbreak.StructureGrowPermBlockRemoval;
import me.moomoo.anarchyexploitfixes.modules.preventions.portals.*;
import me.moomoo.anarchyexploitfixes.modules.preventions.withers.*;
import me.moomoo.anarchyexploitfixes.modules.protocollib.boatfly.AntiBoatFlyModule;
import me.moomoo.anarchyexploitfixes.modules.protocollib.tagparser.AntiTagParserCrash;
import me.moomoo.anarchyexploitfixes.modules.protocollib.windowclick.AntiWindowClickCrash;

import java.util.HashSet;

public interface AnarchyExploitFixesModule {

    String name();
    String category();
    void enable();
    boolean shouldEnable();
    void disable();

    HashSet<AnarchyExploitFixesModule> modules = new HashSet<>();

    static void reloadModules() {
        modules.forEach(AnarchyExploitFixesModule::disable);
        modules.clear();

        /*
            Bedrock
        */
        modules.add(new FillNetherCeilingOnChunkload());
        modules.add(new FillNetherFloorOnChunkload());
        modules.add(new FillOverworldFloorOnChunkload());
        modules.add(new PeriodicallyFillNetherCeiling());
        modules.add(new PeriodicallyFillNetherFloor());
        modules.add(new PeriodicallyFillOverworldFloor());
        modules.add(new PreventGoingBelowBedrockFloor());
        /*
            Chat
        */
        modules.add(new CommandWhitelist());
        modules.add(new PreventPluginScanning());
        /*
            Chunk Limits
        */
        modules.add(new BlockLimit());
        modules.add(new CustomEntityLimit());
        modules.add(new ExpBottleLimit());
        modules.add(new FallingBlockLimit());
        modules.add(new MinecartLimit());
        modules.add(new VehicleLimit());
        modules.add(new NonLivingEntityLimit());
        modules.add(new DroppedItemLimit());
        modules.add(new VillagerLimit());
        /*
            Dupe Preventions
        */
        modules.add(new ChestedEntitiesInPortals());
        modules.add(new ChestsOnEntities());
        modules.add(new CloseEntitiyInventoriesOnLogout());
        modules.add(new CloseEntityInventoryOnChunkUnload());
        modules.add(new EndPortalDupe());
        /*
            Elytra
        */
        modules.add(new ElytraHelper());
        modules.add(new ElytraAtSpawn());
        modules.add(new ElytraGlobal());
        modules.add(new ElytraOnCeiling());
        modules.add(new ElytraPacketFly());
        /*
            Illegals
        */
        // Blocks
        modules.add(new RemoveIllegalBlocksOnChunkload());
        modules.add(new PeriodicallyRemoveIllegalBlocks());
        modules.add(new RemoveUnnaturalSpawners());
        // Items
        modules.add(new BannedItemNames());
        modules.add(new OverstackedItems());
        modules.add(new RevertUnbreakables());
        // Banned Blocks
        modules.add(new BannedMaterial());
        // Enchantments
        modules.add(new IncompatibleEnchants());
        modules.add(new HigherEnchants());
        modules.add(new SpecificHigherEnchants());
        modules.add(new InapplicableEnchants());
        // NBT Items
        modules.add(new DamageModifierTags());
        modules.add(new FilledStorageItemTags());
        // Player head items
        modules.add(new BanPlayerHeads());
        modules.add(new PreventPlacingPlayerHeads());
        // Spawn Eggs
        modules.add(new PreventUsingSpawnEggs());
        modules.add(new RemoveSpawnEggs());
        /*
            Lag Preventions
        */
        modules.add(new LeverSpam());
        modules.add(new SnowballExploit());
        modules.add(new FallingBlockStasis());
        modules.add(new InventoryActionLag());
        modules.add(new LiquidUpdateLag());
        modules.add(new PathfindingLimits());
        modules.add(new PreventFloodingMachines());
        modules.add(new TargetDistanceLimit());
        modules.add(new Explosions());
        modules.add(new BlockPhysics());
        modules.add(new LiquidSpread());
        modules.add(new BlockMelting());
        modules.add(new Redstone());
        modules.add(new Noteblocks());
        modules.add(new FireSpread());
        modules.add(new GrassSpread());
        modules.add(new LeaveDecay());
        /*
            Misc
        */
        modules.add(new FirstJoinMessages());
        modules.add(new JoinLeaveMessages());
        modules.add(new MaskKickMessages());
        modules.add(new PreventMessageKick());
        /*
            Patches
        */
        modules.add(new BookBan());
        modules.add(new MapCursorLag());
        modules.add(new CommandSign());
        modules.add(new GodMode());
        modules.add(new TeleportCoordExploit());
        modules.add(new BeehiveCoordinates());
        modules.add(new WorldChangeCrash());
        /*
            Combat
        */
        modules.add(new Burrow());
        modules.add(new CrystalAuraDelay());
        modules.add(new AnchorAuraDelay());
        modules.add(new BedAuraDelay());
        modules.add(new PistonAuraDelay());
        modules.add(new CrystalAuraHotbarSwitchDelay());
        modules.add(new BowBomb());
        /*
            Preventions
        */
        modules.add(new BedTrap());
        modules.add(new NetherRoof());
        modules.add(new PreventNonSurvival());
        modules.add(new PreventOppedPlayers());
        // Blockbreak
        modules.add(new PistonExplodePermBlockRemoval());
        modules.add(new PistonPlaceWhileRetractPermBlockRemoval());
        modules.add(new StructureGrowPermBlockRemoval());
        // Portals
        modules.add(new EndPortalDestruction());
        modules.add(new PreventAllEntitiesInPortals());
        modules.add(new PreventPortalTraps());
        modules.add(new PreventProjectilesInPortals());
        modules.add(new PreventSpecificEntitiesInPortals());
        // Withers
        modules.add(new DisableWitherSkulls());
        modules.add(new RateLimitWitherSkulls());
        modules.add(new RemoveAllSkullsPeriodically());
        modules.add(new RemoveSkullsAfterXTicks());
        modules.add(new RemoveSkullsOnChunkload());
        modules.add(new RemoveSkullsOnChunkunload());
        modules.add(new WitherSpawningAtSpawn());
        /*
            ProtocolLib
        */
        final boolean protocolLibIsInstalled = unregisterPacketListeners(AnarchyExploitFixes.getInstance());

        modules.add(new AntiBoatFlyModule());
        modules.add(new AntiWindowClickCrash());
        modules.add(new AntiTagParserCrash());

        if (!AnarchyExploitFixes.getConfiguration().protocolLib_IsDisabled && !protocolLibIsInstalled) {
            AnarchyExploitFixes.getPrefixedLogger().error("Could not find ProtocolLib. Packet exploits cannot be patched without it.");
            AnarchyExploitFixes.getPrefixedLogger().error("Download at: https://www.spigotmc.org/resources/protocollib.1997/");
        }

        for (AnarchyExploitFixesModule module : modules) {
            if (module.shouldEnable()) module.enable();
        }
    }

    static boolean unregisterPacketListeners(AnarchyExploitFixes plugin) {
        boolean protocolLibIsInstalled = AnarchyExploitFixes.isProtocolLibInstalled();
        if (protocolLibIsInstalled) ProtocolLibrary.getProtocolManager().removePacketListeners(plugin);
        return protocolLibIsInstalled;
    }
}
