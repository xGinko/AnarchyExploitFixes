package me.moomoo.anarchyexploitfixes.modules.chat;

import com.destroystokyo.paper.event.server.AsyncTabCompleteEvent;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.HandlerList;
import org.bukkit.event.Listener;
import org.bukkit.event.server.TabCompleteEvent;

public class PreventPluginScanning implements AnarchyExploitFixesModule, Listener {

    /*
     *     Credits go to YouHaveTrouble (https://github.com/YouHaveTrouble/CommandWhitelist)
     *     Code was mainly only implemented into AEF by xGinko.
     */

    public PreventPluginScanning() {}

    @Override
    public String name() {
        return "prevent-scanning-server-plugins";
    }

    @Override
    public String category() {
        return "chat";
    }

    @Override
    public void enable() {
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public boolean shouldEnable() {
        return AnarchyExploitFixes.getConfiguration().getBoolean("chat.prevent-scanning-server-plugins.enable", true, "Prevents hacked clients running .plugins to find out what plugins the server is using");
    }

    @Override
    public void disable() {
        HandlerList.unregisterAll(this);
    }

    private boolean isSuspectedScanPacket(String buffer) {
        return (buffer.split(" ").length == 1 && !buffer.endsWith(" ")) || !buffer.startsWith("/");
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    private void onAsyncCommandTabComplete(AsyncTabCompleteEvent event) {
        if (event.getSender().hasPermission("anarchyexploitfixes.chatbypass")) return;
        if (!(event.getSender() instanceof Player)) return;
        if (isSuspectedScanPacket(event.getBuffer())) {
            event.setCancelled(true);
        }
    }

    @EventHandler(priority = EventPriority.NORMAL)
    private void onCommandTabComplete(TabCompleteEvent event) {
        if (event.getSender().hasPermission("anarchyexploitfixes.chatbypass")) return;
        if (!(event.getSender() instanceof Player)) return;
        if (isSuspectedScanPacket(event.getBuffer())) {
            event.setCancelled(true);
        }
    }
}
