package me.xginko.aef.modules.chat;

import com.destroystokyo.paper.event.server.AsyncTabCompleteEvent;
import me.xginko.aef.enums.AEFPermission;
import me.xginko.aef.modules.AEFModule;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.server.TabCompleteEvent;

/**
 * Credits go to YouHaveTrouble (https://github.com/YouHaveTrouble/CommandWhitelist)
 * Code was only implemented into AEF by xGinko.
 */
public class PreventPluginScanning extends AEFModule implements Listener {

    public PreventPluginScanning() {
        super("chat.prevent-scanning-server-plugins");
        config.addComment(configPath + ".enable",
                "Prevents hacked clients running .plugins to find out what plugins\n" +
                        "the server is using.\n" +
                        "Recommended to use in combination with command whitelist.");
    }

    @Override
    public void enable() {
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public boolean shouldEnable() {
        return config.getBoolean(configPath + ".enable", true);
    }

    private boolean isSuspectedScanPacket(String buffer) {
        return (buffer.split(" ").length == 1 && !buffer.endsWith(" ")) || !buffer.startsWith("/");
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    private void onAsyncCommandTabComplete(AsyncTabCompleteEvent event) {
        if (event.getSender().hasPermission(AEFPermission.BYPASS_CHAT.string())) return;
        if (this.isSuspectedScanPacket(event.getBuffer())) {
            event.setCancelled(true);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    private void onCommandTabComplete(TabCompleteEvent event) {
        if (event.getSender().hasPermission(AEFPermission.BYPASS_CHAT.string())) return;
        if (this.isSuspectedScanPacket(event.getBuffer())) {
            event.setCancelled(true);
        }
    }
}